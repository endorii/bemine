generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

enum AttributeType {
    TEXT
    NUMBER
    SELECT
    BOOLEAN
}

enum RoleEmun {
    SELLER
    MODERATOR
    ADMIN
}

enum ListingStatus {
    DRAFT
    PENDING_MODERATION
    ACTIVE
    REJECTED
    ARCHIVED
}

enum ConditionType {
    USED
    NEW
}

enum NotificationType {
    LISTING_APPROVED
    LISTING_REJECTED
    LISTING_FAVORITED
    PRICE_CHANGED
    MESSAGE_RECEIVED
    SYSTEM
}

model Category {
    id     String  @id @default(cuid())
    slug   String
    title  String
    banner String?
    path   String  @unique

    listings   Listing[]
    attributes Attribute[]

    parentId String?
    parent   Category?  @relation("CategoryTree", fields: [parentId], references: [id])
    children Category[] @relation("CategoryTree")

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
}

model Listing {
    id          String        @id @default(cuid())
    title       String
    description String?
    price       Int
    images      String[]      @default([])
    views       Int           @default(0)
    location    String
    condition   ConditionType @default(USED)

    status ListingStatus @default(DRAFT)

    categoryId String
    category   Category @relation(fields: [categoryId], references: [id])

    userId String
    user   User   @relation(fields: [userId], references: [id])

    values        AttributeValue[]
    favorites     Favorite[]
    notifications Notification[]

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
}

model Attribute {
    id    String        @id @default(cuid())
    name  String
    label String
    type  AttributeType

    categoryId String
    category   Category @relation(fields: [categoryId], references: [id])

    values AttributeValue[]

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@unique([name, categoryId])
}

model AttributeValue {
    id String @id @default(cuid())

    listingId String
    listing   Listing @relation(fields: [listingId], references: [id])

    attributeId String
    attribute   Attribute @relation(fields: [attributeId], references: [id])

    value String

    createdAt DateTime @default(now())

    @@unique([listingId, attributeId])
}

model User {
    id       String @id @default(cuid())
    email    String @unique
    phone    String @unique
    password String

    name    String
    surname String

    avatarUrl  String?   @map("avatar_url")
    isOnline   Boolean   @default(false) @map("is_online")
    lastSeenAt DateTime? @map("last_seen_at")

    isVerified               Boolean   @default(false) @map("is_verified")
    verificationToken        String?   @map("verification_token")
    verificationTokenExpires DateTime?

    resetPasswordToken        String?   @map("reset_password_token")
    resetPasswordTokenExpires DateTime? @map("reset_password_token_expires")

    hashedRefreshToken String? @map("hashed_refresh_token")

    role RoleEmun @default(SELLER)

    listings      Listing[]
    favorites     Favorite[]
    notifications Notification[]

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
}

model Favorite {
    id String @id @default(cuid())

    listingId String  @map("listing_id")
    listing   Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)

    userId String @map("user_id")
    user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@unique([userId, listingId])
}

model Notification {
    id String @id @default(cuid())

    title   String
    message String?

    isRead Boolean @default(false)

    type NotificationType

    userId String
    user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

    listingId String?
    listing   Listing? @relation(fields: [listingId], references: [id], onDelete: Cascade)

    createdAt DateTime @default(now())

    @@index([userId, isRead])
}
